name: ğŸš€ Deploy E-Commerce to Production VM

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild Docker images'
        required: false
        default: false
        type: boolean

env:
  PROJECT_PATH: /var/www/sergioferrari/e-commerce
  COMPOSE_FILE: docker-compose.yml

jobs:
  deploy:
    name: ğŸ”„ Deploy to Production Server
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ” Display Deployment Info
        run: |
          echo "ğŸ¯ Deploying to: ${{ env.PROJECT_PATH }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
      
      - name: ğŸ“‚ Upload Files to Production VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "."
          target: ${{ env.PROJECT_PATH }}
          strip_components: 1
          rm: true
          overwrite: true
      
      - name: ğŸ³ Deploy with Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          command_timeout: 10m
          script: |
            set -e
            
            echo "ğŸ”§ Navigating to project directory..."
            cd ${{ env.PROJECT_PATH }}
            
            echo "â¹ï¸  Stopping existing containers..."
            docker-compose down --remove-orphans
            
            echo "ğŸ§¹ Cleaning up unused Docker resources..."
            docker system prune -f
            
            echo "â¬‡ï¸  Pulling latest images..."
            docker-compose pull
            
            BUILD_FLAG=""
            if [[ "${{ github.event.inputs.force_rebuild }}" == "true" ]]; then
              echo "ğŸ”¨ Force rebuilding images..."
              BUILD_FLAG="--build --force-recreate"
            fi
            
            echo "ğŸš€ Starting services..."
            docker-compose up -d $BUILD_FLAG
            
            echo "â±ï¸  Waiting for services to be ready..."
            sleep 30
            
            echo "ğŸ” Checking service health..."
            docker-compose ps
            
            echo "âœ… Deployment completed successfully!"
      
      - name: ğŸ‰ Deployment Success Notification
        if: success()
        run: |
          echo "::notice title=Deployment Success::ğŸ‰ E-commerce application successfully deployed to production!"
      
      - name: âŒ Deployment Failure Notification
        if: failure()
        run: |
          echo "::error title=Deployment Failed::âŒ Deployment to production failed. Please check the logs."